<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, getDocs, writeBatch } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCaXxH4g_RJUazSlkimpHHOKFohn2MVMM8",
        authDomain: "chatwithchaudry.firebaseapp.com",
        projectId: "chatwithchaudry",
        storageBucket: "chatwithchaudry.firebasestorage.app",
        messagingSenderId: "874432806654",
        appId: "1:874432806654:web:cfd8fb88a25091e8722faf"
    };

    const CLOUD_NAME = "dhaydp4rq";
    const UPLOAD_PRESET = "ml_default"; 
    
    // !!! PASTE YOUR KEY FROM ONESIGNAL SETTINGS HERE !!!
    const ONESIGNAL_ID = "de8b239e-81c0-4155-af2e-74209e3dd440"; 
    const ONESIGNAL_REST_KEY = "os_v2_app_32fshhubybavllzooqqj4pouibz7lmqho27ewc47rjwhjloy5fjbb74k4lkbwzwzkgo3sqz7o5htun4i3dxa3zbovbrmy4ed7apl2ui"; // <--- PASTE KEY HERE

    const MY_NUM = "hadi";      
    const FRIEND_NUM = "abdullah"; 

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentUser = "";

    // OneSignal Init
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(function(OneSignal) {
        OneSignal.init({ appId: ONESIGNAL_ID });
    });

    window.login = () => {
        const val = document.getElementById("phoneBox").value.trim().toLowerCase();
        if (val === MY_NUM || val === FRIEND_NUM) {
            currentUser = val;
            document.getElementById("auth-screen").style.display = "none";
            document.getElementById("chat-screen").style.display = "flex";
            document.getElementById("user-display").innerText = val;
            if (val === MY_NUM) document.getElementById("admin-reset").style.display = "block";
            startListening();
        } else {
            document.getElementById("error").style.display = "block";
        }
    };

    // Helper function to send the actual Notification
    async function triggerNotification(text) {
        console.log("Attempting to send notification...");
        try {
            const response = await fetch("https://onesignal.com/api/v1/notifications", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json", 
                    "Authorization": `Basic ${ONESIGNAL_REST_KEY}` 
                },
                body: JSON.stringify({
                    app_id: ONESIGNAL_ID,
                    included_segments: ["All"],
                    contents: { "en": text },
                    headings: { "en": "Private Chat" }
                })
            });
            const result = await response.json();
            console.log("OneSignal Response:", result);
        } catch (error) {
            console.error("Notification Error:", error);
        }
    }

    window.sendText = async () => {
        const input = document.getElementById("text-in");
        if (!input.value.trim()) return;
        const msg = input.value;
        input.value = ""; 

        await addDoc(collection(db, "chats"), {
            sender: currentUser,
            message: msg,
            type: "text",
            time: serverTimestamp()
        });

        // Trigger ONLY if Abdullah is the one sending
        if (currentUser === FRIEND_NUM) {
            triggerNotification("New message from Abdullah!");
        }
    };

    window.uploadMedia = () => {
        const file = document.getElementById("file-btn").files[0];
        if (!file) return;
        const container = document.getElementById("upload-container");
        const fill = document.getElementById("progress-fill");
        const percentText = document.getElementById("percent");
        container.style.display = "block";

        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", UPLOAD_PRESET);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, true);
        xhr.upload.onprogress = (e) => {
            const p = Math.round((e.loaded / e.total) * 100);
            fill.style.width = p + "%";
            percentText.innerText = p + "%";
        };
        xhr.onload = async () => {
            const data = JSON.parse(xhr.responseText);
            await addDoc(collection(db, "chats"), {
                sender: currentUser,
                url: data.secure_url,
                type: data.resource_type,
                time: serverTimestamp()
            });
            container.style.display = "none";
            
            if (currentUser === FRIEND_NUM) {
                triggerNotification("Abdullah sent a photo/video!");
            }
        };
        xhr.send(formData);
    };

    window.masterReset = async () => {
        if (!confirm("Wipe all data?")) return;
        const q = query(collection(db, "chats"));
        const snap = await getDocs(q);
        const batch = writeBatch(db);
        snap.forEach(d => batch.delete(d.ref));
        await batch.commit();
        alert("Wiped.");
    };

    function startListening() {
        const q = query(collection(db, "chats"), orderBy("time", "asc"));
        onSnapshot(q, (snap) => {
            const box = document.getElementById("msg-box");
            box.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                const div = document.createElement("div");
                div.className = `bubble ${d.sender === currentUser ? 'sent' : 'received'}`;
                if (d.type === "text") div.innerText = d.message;
                if (d.type === "image") div.innerHTML = `<img src="${d.url}">`;
                if (d.type === "video") div.innerHTML = `<video src="${d.url}" controls></video>`;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    document.getElementById("text-in").addEventListener("keypress", (e) => { if(e.key === "Enter") window.sendText(); });
</script>
