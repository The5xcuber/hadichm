<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Chat With Chaudry</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico?v=1">
    <style>
        :root { --bg-deep: #111b21; --header-bg: #202c33; --input-bg: #2a3942; --my-msg-bg: #005c4b; --friend-msg-bg: #202c33; --text-primary: #e9edef; --text-secondary: #8696a0; --accent: #00a884; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #090e11; color: var(--text-primary); margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        #app { width: 100%; max-width: 600px; background: var(--bg-deep); display: flex; flex-direction: column; height: 100vh; position: relative; }
        #auth-screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; background: radial-gradient(circle at top, #1f2c34, #111b21); z-index: 100; }
        #phoneBox { padding: 15px; width: 80%; border: 1px solid #374045; border-radius: 25px; background: var(--input-bg); color: white; text-align: center; margin-bottom: 20px; outline: none; }
        #chat-screen { display: none; flex-direction: column; height: 100%; animation: fadeIn 0.4s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        header { background: var(--header-bg); padding: 12px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 15px; }
        .avatar { width: 40px; height: 40px; background: #607d8b; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .header-info { flex: 1; display: flex; flex-direction: column; }
        #friend-name { font-weight: 600; font-size: 16px; color: white; }
        .status-row { display: flex; align-items: center; gap: 5px; font-size: 12px; margin-top: 2px; }
        #status-dot { width: 8px; height: 8px; border-radius: 50%; background: #8696a0; }
        #status-text { color: var(--text-secondary); }
        #typing-indicator { font-size: 12px; color: var(--accent); height: 14px; margin-top: 2px; font-weight: 500; }
        #msg-box { flex: 1; overflow-y: auto; padding: 20px 15px; display: flex; flex-direction: column; gap: 5px; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); background-color: #0b141a; background-blend-mode: soft-light; }
        .bubble { padding: 8px 12px; border-radius: 8px; max-width: 80%; font-size: 15px; position: relative; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .sent { align-self: flex-end; background: var(--my-msg-bg); border-top-right-radius: 0; }
        .received { align-self: flex-start; background: var(--friend-msg-bg); border-top-left-radius: 0; }
        .bubble img, .bubble video { max-width: 100%; border-radius: 6px; margin-top: 5px; display: block; }
        #input-area { background: var(--header-bg); padding: 10px 15px; display: flex; align-items: center; gap: 10px; }
        #text-in { flex: 1; background: var(--input-bg); border: none; padding: 12px 18px; border-radius: 25px; color: white; outline: none; }
        .btn { padding: 10px 20px; background: var(--accent); color: #111b21; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; }
        #upload-container { display: none; background: var(--header-bg); padding: 10px 20px; border-bottom: 1px solid var(--accent); }
        .progress-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 5px; }
        #progress-fill { width: 0%; height: 100%; background: var(--accent); transition: width 0.3s; }
        a { color: #53bdeb; }
    </style>
</head>
<body>

<audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3" preload="auto"></audio>

<div id="app">
    <div id="auth-screen">
        <h2 style="color: #00a884;">Private Chat</h2>
        <input type="text" id="phoneBox" placeholder="Enter code word...">
        <button class="btn" onclick="login()">ENTER</button>
    </div>

    <div id="chat-screen">
        <header>
            <div class="avatar">ðŸ‘¤</div>
            <div class="header-info">
                <span id="friend-name">Loading...</span>
                <div class="status-row">
                    <div id="status-dot"></div>
                    <span id="status-text">Offline</span>
                </div>
                <div id="typing-indicator"></div>
            </div>
            <button id="admin-reset" style="display:none; background:none; border:1px solid #ef5350; color:#ef5350; padding:4px 8px; border-radius:4px; font-size:10px;" onclick="masterReset()">RESET</button>
        </header>
        <div id="upload-container"><div class="progress-bg"><div id="progress-fill"></div></div></div>
        <div id="msg-box"></div>
        <div id="input-area">
            <label style="cursor:pointer; font-size:22px;">ðŸ“Ž<input type="file" id="file-btn" hidden onchange="uploadMedia()"></label>
            <input type="text" id="text-in" placeholder="Type a message..." oninput="handleTyping()">
            <button class="btn" onclick="sendText()">âž¤</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, getDocs, writeBatch, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyCaXxH4g_RJUazSlkimpHHOKFohn2MVMM8", authDomain: "chatwithchaudry.firebaseapp.com", projectId: "chatwithchaudry", storageBucket: "chatwithchaudry.firebasestorage.app", messagingSenderId: "874432806654", appId: "1:874432806654:web:cfd8fb88a25091e8722faf" };
    const CLOUD_NAME = "dhaydp4rq";
    const UPLOAD_PRESET = "ml_default"; 

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentUser = "", friendUser = "", typingTimeout, isFirstLoad = true;

    window.login = () => {
        const val = document.getElementById("phoneBox").value.trim();
        if (val === "hadi" || val === "Abdullah") {
            currentUser = val;
            friendUser = (val === "hadi") ? "Abdullah" : "hadi";
            document.getElementById("auth-screen").style.display = "none";
            document.getElementById("chat-screen").style.display = "flex";
            document.getElementById("friend-name").innerText = friendUser;
            if (val === "hadi") document.getElementById("admin-reset").style.display = "block";
            
            // Notification Permission
            if (Notification.permission !== "granted") Notification.requestPermission();
            
            updateStatus(true);
            startListening();
            listenToFriend();
        } else { alert("Wrong code!"); }
    };

    async function updateStatus(isOnline) { if (currentUser) await setDoc(doc(db, "status", currentUser), { online: isOnline }, { merge: true }); }
    window.addEventListener("beforeunload", () => updateStatus(false));

    function listenToFriend() {
        onSnapshot(doc(db, "status", friendUser), (snap) => {
            const data = snap.data();
            const dot = document.getElementById("status-dot"), text = document.getElementById("status-text"), typing = document.getElementById("typing-indicator");
            if (data && data.online) { dot.style.background = "#25d366"; text.innerText = "Online"; text.style.color = "#25d366"; } 
            else { dot.style.background = "#8696a0"; text.innerText = "Offline"; text.style.color = "#8696a0"; }
            typing.innerText = (data && data.typing) ? friendUser + " is typing..." : "";
        });
    }

    window.handleTyping = () => {
        setDoc(doc(db, "status", currentUser), { typing: true }, { merge: true });
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => { setDoc(doc(db, "status", currentUser), { typing: false }, { merge: true }); }, 2000);
    };

    window.sendText = async () => {
        const input = document.getElementById("text-in");
        if (!input.value.trim()) return;
        const msg = input.value; input.value = "";
        await addDoc(collection(db, "chats"), { sender: currentUser, message: msg, type: "text", time: serverTimestamp() });
    };

    function startListening() {
        onSnapshot(query(collection(db, "chats"), orderBy("time", "asc")), (snap) => {
            const box = document.getElementById("msg-box");
            let lastMsg = null;
            box.innerHTML = "";
            snap.forEach(docSnap => {
                const d = docSnap.data();
                lastMsg = d;
                const div = document.createElement("div");
                div.className = `bubble ${d.sender === currentUser ? 'sent' : 'received'}`;
                if (d.type === "text") div.innerText = d.message;
                else if (d.type === "image") div.innerHTML = `<img src="${d.url}">`;
                else if (d.type === "video") div.innerHTML = `<video controls playsinline><source src="${d.url}" type="video/mp4"></video>`;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;

            // Notification Logic
            if (!isFirstLoad && lastMsg && lastMsg.sender !== currentUser) {
                document.getElementById("notif-sound").play();
                if (document.hidden) {
                    document.title = "(1) New Message!";
                    if (Notification.permission === "granted") new Notification("New message from " + friendUser, { body: lastMsg.message || "Sent a file" });
                }
            }
            isFirstLoad = false;
        });
    }

    window.addEventListener("focus", () => { document.title = "Private Chat With Chaudry"; });

    window.uploadMedia = () => {
        const file = document.getElementById("file-btn").files[0];
        if (!file) return;
        document.getElementById("upload-container").style.display = "block";
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", UPLOAD_PRESET);
        const xhr = new XMLHttpRequest();
        xhr.open("POST", `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${file.type.startsWith('video')?'video':'image'}/upload`, true);
        xhr.upload.onprogress = (e) => { document.getElementById("progress-fill").style.width = Math.round((e.loaded / e.total) * 100) + "%"; };
        xhr.onload = async () => {
            let url = JSON.parse(xhr.responseText).secure_url;
            if (file.type.startsWith('video')) url = url.replace(/\.[^/.]+$/, ".mp4");
            await addDoc(collection(db, "chats"), { sender: currentUser, url, type: file.type.startsWith('video')?'video':'image', time: serverTimestamp() });
            document.getElementById("upload-container").style.display = "none";
        };
        xhr.send(formData);
    };
</script>
</body>
</html>
