<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Private Chat</title>
    <style>
        :root { --bg: #0b141a; --header: #202c33; --my-msg: #005c4b; --friend-msg: #202c33; --text: #e9edef; }
        body { font-family: 'Segoe UI', sans-serif; background: #000; color: var(--text); margin: 0; display: flex; justify-content: center; height: 100dvh; overflow: hidden; }
        #app { width: 100%; max-width: 500px; background: var(--bg); display: flex; flex-direction: column; height: 100dvh; }
        
        #auth-screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        input[type="text"] { padding: 12px; width: 85%; border: none; border-radius: 8px; background: #2a3942; color: white; margin: 10px 0; font-size: 16px; outline: none; }
        .btn { padding: 12px 30px; background: #00a884; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }

        #chat-screen { display: none; flex-direction: column; height: 100%; }
        header { background: var(--header); padding: 15px; font-weight: bold; border-bottom: 1px solid #374045; }
        #msg-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; }
        
        .bubble { padding: 8px 12px; border-radius: 10px; max-width: 75%; font-size: 14px; line-height: 1.4; box-shadow: 0 1px 1px rgba(0,0,0,0.2); word-wrap: break-word; }
        .sent { align-self: flex-end; background: var(--my-msg); border-top-right-radius: 0; }
        .received { align-self: flex-start; background: var(--friend-msg); border-top-left-radius: 0; }
        .bubble img, .bubble video { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; }

        #input-area { background: var(--header); padding: 10px; display: flex; align-items: center; gap: 10px; }
        #text-in { flex: 1; background: #2a3942; border: none; padding: 12px; border-radius: 20px; color: white; outline: none; }
        
        /* Progress Bar Styling */
        #upload-container { display: none; background: #202c33; padding: 10px; border-bottom: 1px solid #00a884; }
        .progress-bg { width: 100%; height: 6px; background: #2a3942; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        #progress-fill { width: 0%; height: 100%; background: #00a884; transition: width 0.3s ease; }
        
        #admin-reset { display: none; background: #ff3b30; color: white; border: none; border-radius: 12px; font-size: 10px; padding: 5px 10px; float: right; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="app">
    <div id="auth-screen">
        <h2 style="color: #00a884;">Private Chat</h2>
        <p style="opacity: 0.7;">Enter your secret code word</p>
        <input type="text" id="phoneBox" placeholder="Code word here...">
        <button class="btn" onclick="login()">Login</button>
        <p id="error" style="color:#ff5e5e; display:none; margin-top:10px;">Access Denied!</p>
    </div>

    <div id="chat-screen">
        <header>
            Chatting as: <span id="user-display" style="color:#00a884;"></span>
            <button id="admin-reset" onclick="masterReset()">RESET CHAT</button>
        </header>

        <div id="upload-container">
            <div style="font-size:12px; margin-bottom:5px;">Uploading... <span id="percent">0%</span></div>
            <div class="progress-bg">
                <div id="progress-fill"></div>
            </div>
        </div>

        <div id="msg-box"></div>
        
        <div id="input-area">
            <label style="cursor:pointer; font-size:24px;">ðŸ“Ž
                <input type="file" id="file-btn" hidden onchange="uploadMedia()">
            </label>
            <input type="text" id="text-in" placeholder="Type a message">
            <button class="btn" onclick="sendText()">âž¤</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, getDocs, writeBatch } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCaXxH4g_RJUazSlkimpHHOKFohn2MVMM8",
        authDomain: "chatwithchaudry.firebaseapp.com",
        projectId: "chatwithchaudry",
        storageBucket: "chatwithchaudry.firebasestorage.app",
        messagingSenderId: "874432806654",
        appId: "1:874432806654:web:cfd8fb88a25091e8722faf"
    };

    const CLOUD_NAME = "dhaydp4rq";
    const UPLOAD_PRESET = "ml_default"; 

    const MY_NUM = "hadi";      
    const FRIEND_NUM = "abdullah"; 

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let currentUser = "";

    window.login = () => {
        const val = document.getElementById("phoneBox").value.trim();
        if (val === MY_NUM || val === FRIEND_NUM) {
            currentUser = val;
            document.getElementById("auth-screen").style.display = "none";
            document.getElementById("chat-screen").style.display = "flex";
            document.getElementById("user-display").innerText = val;
            
            // Show Reset Button ONLY for you
            if (val === MY_NUM) {
                document.getElementById("admin-reset").style.display = "block";
            }
            
            startListening();
        } else {
            document.getElementById("error").style.display = "block";
        }
    };

    window.sendText = async () => {
        const input = document.getElementById("text-in");
        if (!input.value.trim()) return;
        const msg = input.value;
        input.value = ""; 
        await addDoc(collection(db, "chats"), {
            sender: currentUser,
            message: msg,
            type: "text",
            time: serverTimestamp()
        });
    };

    document.getElementById("text-in").addEventListener("keypress", (e) => {
        if (e.key === "Enter") window.sendText();
    });

    window.uploadMedia = async () => {
        const file = document.getElementById("file-btn").files[0];
        if (!file) return;

        const container = document.getElementById("upload-container");
        const fill = document.getElementById("progress-fill");
        const percentText = document.getElementById("percent");
        
        container.style.display = "block";

        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", UPLOAD_PRESET);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, true);

        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
                const progress = Math.round((e.loaded / e.total) * 100);
                fill.style.width = progress + "%";
                percentText.innerText = progress + "%";
            }
        };

        xhr.onload = async () => {
            const data = JSON.parse(xhr.responseText);
            await addDoc(collection(db, "chats"), {
                sender: currentUser,
                url: data.secure_url,
                type: data.resource_type,
                time: serverTimestamp()
            });
            container.style.display = "none";
            fill.style.width = "0%";
        };

        xhr.onerror = () => {
            alert("Upload failed. Check Cloudinary settings.");
            container.style.display = "none";
        };

        xhr.send(formData);
    };

    window.masterReset = async () => {
        if (!confirm("Delete all messages and media? This cannot be undone.")) return;
        
        try {
            const q = query(collection(db, "chats"));
            const snapshot = await getDocs(q);
            const batch = writeBatch(db);
            
            snapshot.forEach((doc) => {
                batch.delete(doc.ref);
            });
            
            await batch.commit();
            alert("Chat Wiped!");
        } catch (err) {
            console.error("Reset failed: ", err);
            alert("Error wiping chat. Check Firestore Rules.");
        }
    };

    function startListening() {
        const q = query(collection(db, "chats"), orderBy("time", "asc"));
        onSnapshot(q, (snap) => {
            const box = document.getElementById("msg-box");
            box.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                const div = document.createElement("div");
                div.className = `bubble ${d.sender === currentUser ? 'sent' : 'received'}`;
                
                if (d.type === "image") div.innerHTML += `<img src="${d.url}">`;
                if (d.type === "video") div.innerHTML += `<video src="${d.url}" controls></video>`;
                if (d.message) div.innerHTML += `<div>${d.message}</div>`;
                
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    }
</script>
</body>
</html>
